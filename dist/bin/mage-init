#!/usr/bin/env bash

set -euo pipefail

cd "$HOME"/public_html

echo "Initializing DockerMagento2..."

echo "Searching for magento-docker to run init..."
if [[ -x ./bin/magento-docker ]]; then
  yes | ./bin/magento-docker init || true
else
  echo "Did not find bin/magento-docker :-("
  exit 1
fi

if [[ ! -e ./.docker/config.env ]]; then
  echo ".docker/config.env file missing. Please run vendor/bin/ece-docker build:compose..."
fi

if [[ -e ./app/etc/env.php ]]; then
  echo "Clearing previous db key (by removing app/etc/env.php)"
  rm -f ./app/etc/env.php
fi

echo "Cloud deploy and post-deploy..."
./magento-docker ece-deploy
./magento-docker ece-post-deploy

echo "INIT COMPLETE"

exit 0
